<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ERIS CORE: calling-c-from-wren</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">ERIS CORE
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "../../search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('d9/deb/md__e_r_i_s_core_lib_wren_doc_site_embedding_calling_c_from_wren.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">calling-c-from-wren </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>^title Calling C from Wren</p>
<p>When we are ensconced within the world of Wren, the external C world is "foreign" to us. There are two reasons we might want to bring some foreign flavor into our VM:</p>
<ul>
<li>We want to execute code written in C.</li>
<li>We want to store raw C data.</li>
</ul>
<p>Since Wren is object-oriented, behavior lives in methods, so for the former we have <b>foreign methods</b>. Likewise, data lives in objects, so for the latter, we define <b>foreign classes</b>. This page is about the first, foreign methods. The <a href="../..//embedding/storing-c-data.html">next page</a> covers foreign classes.</p>
<p>A foreign method looks to Wren like a regular method. It is defined on a Wren class, it has a name and signature, and calls to it are dynamically dispatched. The only difference is that the <em>body</em> of the method is written in C.</p>
<p>A foreign method is declared in Wren like so:</p>
<pre class="snippet">
class Math {
  foreign static add(a, b)
}
</pre><p>The <code>foreign</code> keyword tells Wren that the method <code>add()</code> is declared on <code>Math</code>, but implemented in C. Both static and instance methods can be foreign.</p>
<h2><a class="anchor" id="autotoc_md153"></a>
Binding Foreign Methods</h2>
<p>When you call a foreign method, Wren needs to figure out which C function to execute. This process is called <em>binding</em>. Binding is performed on-demand by the VM. When a class that declares a foreign method is executed &ndash; when the <code>class</code> statement itself is evaluated &ndash; the VM asks the host application for the C function that should be used for the foreign method.</p>
<p>It does this through the <code>bindForeignMethodFn</code> callback you give it when you first <a href="../../configuring-the-vm.html">configure the VM</a>. This callback isn't the foreign method itself. It's the binding function your app uses to <em>look up</em> foreign methods.</p>
<p>Its signature is:</p>
<pre class="snippet" data-lang="c">
WrenForeignMethodFn bindForeignMethodFn(
    WrenVM* vm,
    const char* module,
    const char* className,
    bool isStatic,
    const char* signature);
</pre><p>Every time a foreign method is first declared, the VM invokes this callback. It passes in the module containing the class declaration, the name of the class containing the method, the method's signature, and whether or not it's a static method. In the above example, it would pass something like:</p>
<pre class="snippet" data-lang="c">
bindForeignMethodFn(vm, "main", "Math", true, "add(_,_)");
</pre><p>When you configure the VM, you give it a C callback that looks up the appropriate function for the given foreign method and returns a pointer to it. Something like:</p>
<pre class="snippet" data-lang="c">
WrenForeignMethodFn bindForeignMethod(
    WrenVM* vm,
    const char* module,
    const char* className,
    bool isStatic,
    const char* signature)
{
  if (strcmp(module, "main") == 0)
  {
    if (strcmp(className, "Math") == 0)
    {
      if (isStatic &amp;&amp; strcmp(signature, "add(_,_)") == 0)
      {
        return mathAdd; // C function for Math.add(_,_).
      }
      // Other foreign methods on Math...
    }
    // Other classes in main...
  }
  // Other modules...
}
</pre><p>This implementation is pretty tedious, but you get the idea. Feel free to do something more clever here in your host application.</p>
<p>The important part is that it returns a pointer to a C function to use for that foreign method. Wren does this binding step <em>once</em> when the class definition is first executed. It then keeps the function pointer you return and associates it with that method. This way, <em>calls</em> to the foreign method are fast.</p>
<h2><a class="anchor" id="autotoc_md154"></a>
Implementing a Foreign Method</h2>
<p>All C functions for foreign methods have the same signature:</p>
<pre class="snippet" data-lang="c">
void foreignMethod(WrenVM* vm);
</pre><p>Arguments passed from Wren are not passed as C arguments, and the method's return value is not a C return value. Instead &ndash; you guessed it &ndash; we go through the <a href="../..//embedding/slots-and-handles.html">slot array</a>.</p>
<p>When a foreign method is called from Wren, the VM sets up the slot array with the receiver and arguments to the call. As in calling Wren from C, the receiver object is in slot zero, and arguments are in consecutive slots after that.</p>
<p>You use the slot API to read those arguments, and then perform whatever work you want to in C. If you want the foreign method to return a value, place it in slot zero. Like so:</p>
<pre class="snippet" data-lang="c">
void mathAdd(WrenVM* vm)
{
  double a = wrenGetSlotDouble(vm, 1);
  double b = wrenGetSlotDouble(vm, 2);
  wrenSetSlotDouble(vm, 0, a + b);
}
</pre><p>While your foreign method is executing, the VM is completely suspended. No other fibers run until your foreign method returns. You should <em>not</em> try to resume the VM from within a foreign method by calling <code><a class="el" href="../../dd/d19/wren_8h.html#a4bbb5e4dc3f5b794c88b4210e30927ba">wrenCall()</a></code> or <code><a class="el" href="../../dd/d19/wren_8h.html#a653b065ece2f5fb52dc3ff41e7c8322a">wrenInterpret()</a></code>. The VM is not re-entrant.</p>
<p>This covers foreign behavior, but what about foreign <em>state</em>? For that, we need a foreign <em>class</em>...</p>
<p><a href="../../storing-c-data.html" class="right">Storing C Data &rarr;</a> <a href="../../calling-wren-from-c.html">&larr; Calling Wren from C</a> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
