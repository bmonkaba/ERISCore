<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ERIS CORE: calling-wren-from-c</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">ERIS CORE
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "../../search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('d6/d5f/md__e_r_i_s_core_lib_wren_doc_site_embedding_calling_wren_from_c.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">calling-wren-from-c </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>^title Calling Wren from C</p>
<p>From C, we can tell Wren to do stuff by calling <code><a class="el" href="../../dd/d19/wren_8h.html#a653b065ece2f5fb52dc3ff41e7c8322a">wrenInterpret()</a></code>, but that's not always the ideal way to drive the VM. First of all, it's slow. It has to parse and compile the string of source code you give it. Wren has a pretty fast compiler, but that's still a good bit of work.</p>
<p>It's also not an effective way to communicate. You can't pass arguments to Wren&mdash;at least, not without doing something nasty like converting them to literals in a string of source code&mdash;and you can't get a result value back.</p>
<p><code><a class="el" href="../../dd/d19/wren_8h.html#a653b065ece2f5fb52dc3ff41e7c8322a">wrenInterpret()</a></code> is great for loading code into the VM, but it's not the best way to execute code that's already been loaded. What we want to do is invoke some already compiled chunk of code. Since Wren is an object-oriented language, "chunk of code" means a <a href="../../../method-calls.html">method</a>, not a <a href="../../../functions.html">function</a>.</p>
<p>The C API for doing this is <code><a class="el" href="../../dd/d19/wren_8h.html#a4bbb5e4dc3f5b794c88b4210e30927ba">wrenCall()</a></code>. In order to invoke a Wren method from C, we need a few things:</p>
<ul>
<li><b>The method to call.</b> Wren is dynamically typed, so this means we'll look it up by name. Further, since Wren supports overloading by arity, we actually need its entire <a href="../../../method-calls.html#signature">signature</a>.</li>
<li><b>The receiver object to invoke the method on.</b> The receiver's class determines which method is actually called.</li>
<li><b>The arguments to pass to the method.</b></li>
</ul>
<p>We'll tackle these one at a time.</p>
<h3><a class="anchor" id="autotoc_md225"></a>
Getting a Method Handle</h3>
<p>When you run a chunk of Wren code like this:</p>
<pre class="snippet">
object.someMethod(1, 2, 3)
</pre><p>At runtime, the VM has to look up the class of <code>object</code> and find a method there whose signature is <code>someMethod(_,_,_)</code>. This sounds like it's doing some string manipulation&mdash;at the very least hashing the signature&mdash;every time a method is called. That's how many dynamic languages work.</p>
<p>But, as you can imagine, that's pretty slow. So, instead, Wren does as much of that work at compile time as it can. When it's compiling the above code to bytecode, it takes that method signature a converts it to a <em>method symbol</em>, a number that uniquely identifes that method. That's the only part of the process that requires treating a signature as a string.</p>
<p>At runtime, the VM just looks for the method <em>symbol</em> in the receiver's class's method table. In fact, the way it's implemented today, the symbol is simply the array index into the table. That's <a href="../../../performance.html">why method calls are so fast</a> in Wren.</p>
<p>It would be a shame if calling a method from C didn't have that same speed benefit. To achieve that, we split the process of calling a method into two steps. First, we create a handle that represents a "compiled" method signature:</p>
<pre class="snippet" data-lang="c">
WrenHandle* <a class="el" href="../../de/db2/wren__vm_8c.html#a7d0c3d6e0b8d6766eab22c6a07d2f10d">wrenMakeCallHandle(WrenVM* vm, const char* signature)</a>;
</pre><p>That takes a method signature as a string and gives you back an opaque handle that represents the compiled method symbol. Now you have a <em>reusable</em> handle that can be used to very quickly call a certain method given a receiver and some arguments.</p>
<p>This is just a regular <a class="el" href="../../d7/d18/struct_wren_handle.html">WrenHandle</a>, which means you can hold onto it as long as you like. Typically, you'd call this once outside of your application's performance critical loops and reuse it as long as you need. It is us up to you to release it when you no longer need it by calling <code><a class="el" href="../../dd/d19/wren_8h.html#a146d920cb320a0069edef09a8de86a43">wrenReleaseHandle()</a></code>.</p>
<h2><a class="anchor" id="autotoc_md227"></a>
Setting Up a Receiver</h2>
<p>OK, we have a method, but who are we calling it on? We need a receiver, and as you can probably guess after reading the <a href="../../slots-and-handles.html">last section</a>, we give that to Wren by storing it in a slot. In particular, <b>the receiver for a method call goes in slot zero.</b></p>
<p>Any object you store in that slot can be used as a receiver. You could even call <code>+</code> on a number by storing a number in there if you felt like it.</p>
<p>Needing a receiver to call some Wren code from C might feel strange. C is procedural, so it's natural to want to just invoke a bare <em>function</em> from Wren, but Wren isn't procedural. Instead, if you want to define some executable operation that isn't logically tied to a specific object, the natural way is to define a static method on an appropriate class.</p>
<p>For example, say we're making a game engine. From C, we want to tell the game engine to update all of the entities each frame. We'll keep track of the list of entities within Wren, so from C, there's no obvious object to call <code>update(_)</code> on. Instead, we'll just make it a static method:</p>
<pre class="snippet">
class GameEngine {
  static update(elapsedTime) {
    // ...
  }
}
</pre><p>Often, when you call a Wren method from C, you'll be calling a static method. But, even then, you need a receiver. Now, though, the receiver is the <em>class itself</em>. Classes are first class objects in Wren, and when you define a named class, you're really declaring a variable with the class's name and storing a reference to the class object in it.</p>
<p>Assuming you declared that class at the top level, the C API <a href="../../slots-and-handles.html#looking-up-variables">gives you a way to look it up</a>. We can get a handle to the above class like so:</p>
<pre class="snippet" data-lang="c">
// Load the class into slot 0.
wrenEnsureSlots(vm, 1);
wrenGetVariable(vm, "main", "GameEngine", 0);
</pre><p>We could do this every time we call <code>update()</code>, but, again, that's kind of slow because we're looking up "GameEngine" by name each time. A faster solution is to create a handle to the class once and use it each time:</p>
<pre class="snippet" data-lang="c">
// Load the class into slot 0.
wrenEnsureSlots(vm, 1);
wrenGetVariable(vm, "main", "GameEngine", 0);
WrenHandle* gameEngineClass = wrenGetSlotHandle(vm, 0);
</pre><p>Now, each time we want to call a method on GameEngine, we store that value back in slot zero:</p>
<pre class="snippet" data-lang="c">
wrenSetSlotHandle(vm, 0, gameEngineClass);
</pre><p>Just like we hoisted <code><a class="el" href="../../dd/d19/wren_8h.html#abe767089c421873af8384fba0934cd26">wrenMakeCallHandle()</a></code> out of our performance critical loop, we can hoist the call to <code><a class="el" href="../../dd/d19/wren_8h.html#aa479b76893c2f35d2dd3c5aab0e69bb2">wrenGetVariable()</a></code> out. Of course, if your code isn't performance critical, you don't have to do this.</p>
<h2><a class="anchor" id="autotoc_md229"></a>
Passing Arguments</h2>
<p>We've got a receiver in slot zero now, next we need to pass in any other arguments. In our GameEngine example, that's just the elapsed time. <a class="el" href="../../d4/d3e/struct_method.html">Method</a> arguments go in consecutive slots after the receiver. So the elapsed time goes into slot one. You can use any of the slot functions to set this up. For the example, it's just:</p>
<pre class="snippet" data-lang="c">
wrenSetSlotDouble(vm, 1, elapsedTime);
</pre><h2><a class="anchor" id="autotoc_md230"></a>
Calling the Method</h2>
<p>We have all of the data in place, so all that's left is to pull the trigger and tell the VM to start running some code:</p>
<pre class="snippet" data-lang="c">
WrenInterpretResult <a class="el" href="../../de/db2/wren__vm_8c.html#a645b672702feb103a02be79be37a2aaf">wrenCall(WrenVM* vm, WrenHandle* method)</a>;
</pre><p>It takes the method handle we created using <code><a class="el" href="../../dd/d19/wren_8h.html#abe767089c421873af8384fba0934cd26">wrenMakeCallHandle()</a></code>. Now Wren starts running code. It looks up the method on the receiver, executes it and keeps running until either the method returns or a fiber <a href="../../../modules/core/fiber.html#fiber.suspend()">suspends</a>.</p>
<p><code><a class="el" href="../../dd/d19/wren_8h.html#a4bbb5e4dc3f5b794c88b4210e30927ba">wrenCall()</a></code> returns the same WrenInterpretResult enum as <code><a class="el" href="../../dd/d19/wren_8h.html#a653b065ece2f5fb52dc3ff41e7c8322a">wrenInterpret()</a></code> to tell you if the method completed successfully or a runtime error occurred. (<code><a class="el" href="../../dd/d19/wren_8h.html#a4bbb5e4dc3f5b794c88b4210e30927ba">wrenCall()</a></code> never returns <code>WREN_ERROR_COMPILE</code> since it doesn't compile anything.)</p>
<h2><a class="anchor" id="autotoc_md232"></a>
Getting the Return Value</h2>
<p>When <code><a class="el" href="../../dd/d19/wren_8h.html#a4bbb5e4dc3f5b794c88b4210e30927ba">wrenCall()</a></code> returns, it leaves the slot array in place. In slot zero, you can find the method's return value, which you can access using any of the slot reading functions. If you don't need the return value, you can ignore it.</p>
<p>This is how you drive Wren from C, but how do you put control in Wren's hands? For that, you'll need the next section...</p>
<p><a href="../../calling-c-from-wren.html" class="right">Calling C From Wren &rarr;</a> <a href="../../slots-and-handles.html">&larr; Slots and Handles</a> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
