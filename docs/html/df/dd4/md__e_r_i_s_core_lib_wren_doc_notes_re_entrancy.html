<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ERIS CORE: wrenInterpret()</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">ERIS CORE
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "../../search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('df/dd4/md__e_r_i_s_core_lib_wren_doc_notes_re_entrancy.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title"><a class="el" href="../../dd/d19/wren_8h.html#a653b065ece2f5fb52dc3ff41e7c8322a">wrenInterpret()</a> </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>You can already call out to a foreign method or constructor from within an execution that was started using <code><a class="el" href="../../dd/d19/wren_8h.html#a653b065ece2f5fb52dc3ff41e7c8322a">wrenInterpret()</a></code>, so I think that's fine. <code><a class="el" href="../../dd/d19/wren_8h.html#a653b065ece2f5fb52dc3ff41e7c8322a">wrenInterpret()</a></code> doesn't use the API stack at all.</p>
<h1><a class="anchor" id="autotoc_md3"></a>
wrenCall()</h1>
<p>Normally, when using <code><a class="el" href="../../dd/d19/wren_8h.html#a4bbb5e4dc3f5b794c88b4210e30927ba">wrenCall()</a></code> to start executing some code, the API slots are at the very bottom of the fiber's stack and the fiber has no other callframes until execution begins.</p>
<p>When a foreign method or constructor is called, there <em>are</em> callframes on the fiber's stack. There must be, because that's where the arguments to the foreign method are.</p>
<p>So, if you <code><a class="el" href="../../dd/d19/wren_8h.html#a4bbb5e4dc3f5b794c88b4210e30927ba">wrenCall()</a></code>, which eventually calls a foreign method, the same fiber will be used for the API twice. This is currently broken. The reason it's broken is that <code><a class="el" href="../../de/db2/wren__vm_8c.html#ad56222d53b8fb7ca7bc8e995511fa481">callForeign()</a></code> and <code><a class="el" href="../../de/db2/wren__vm_8c.html#a5020cc736d0f9d681e5bed6f2804bf5a">createForeign()</a></code> store the old apiStack pointer (the one used for the initial <code><a class="el" href="../../dd/d19/wren_8h.html#a4bbb5e4dc3f5b794c88b4210e30927ba">wrenCall()</a></code>) in a local variable and then restore it when the foreign call completes. If a GC or stack grow occurs in the middle of that, we end up restoring a bad pointer.</p>
<p>But I don't think we need to preserve apiStack for the <code><a class="el" href="../../dd/d19/wren_8h.html#a4bbb5e4dc3f5b794c88b4210e30927ba">wrenCall()</a></code> anyway. As soon as the user calls <code><a class="el" href="../../dd/d19/wren_8h.html#a4bbb5e4dc3f5b794c88b4210e30927ba">wrenCall()</a></code> and it starts running, we no longer need to track the number of slots allocated for the API. All that matters is that the one return value is available at the end.</p>
<p>I think this means it <em>should</em> be fairly easy to support: </p><pre class="fragment">wrenCall() -&gt; wren code -&gt; foreign method
</pre> <h1><a class="anchor" id="autotoc_md4"></a>
Foreign calls</h1>
<p>The interesting one is whether you can call <code><a class="el" href="../../dd/d19/wren_8h.html#a653b065ece2f5fb52dc3ff41e7c8322a">wrenInterpret()</a></code> or <code><a class="el" href="../../dd/d19/wren_8h.html#a4bbb5e4dc3f5b794c88b4210e30927ba">wrenCall()</a></code> from within a foreign method. If we're going to allow re-entrancy at all, it would be nice to completely support it. I do think there are practical uses for this.</p>
<p>Calling <code><a class="el" href="../../dd/d19/wren_8h.html#a653b065ece2f5fb52dc3ff41e7c8322a">wrenInterpret()</a></code> should already work, though I don't think it's tested.</p>
<p>Calling <code><a class="el" href="../../dd/d19/wren_8h.html#a4bbb5e4dc3f5b794c88b4210e30927ba">wrenCall()</a></code> is probably broken. It will try to re-use the slots that are already set up for the foreign call and then who knows what happens if you start to execute.</p>
<p>I think a key part of the problem is that we implicitly create or reuse the API stack as soon as you start messing with slots. So if there already happens to be an API stack &ndash; because you're in the middle of a foreign method &ndash; it will incorrectly reuse it when you start preparing for the <code><a class="el" href="../../dd/d19/wren_8h.html#a4bbb5e4dc3f5b794c88b4210e30927ba">wrenCall()</a></code>.</p>
<p>An obvious fix is to add a new function like <code>wrenPrepareCall()</code> that explicitly creates a new API stack &ndash; really a new fiber &ndash; for you to use. We still have to figure out how to keep track of the current API stack and fiber for the foreign call so that we can return to it.</p>
<p><b>TODO: more thinking here...</b></p>
<p>If I can figure this out, it means we can do: </p><pre class="fragment">foreign method -&gt; C code -&gt; wrenCall()
</pre> <h1><a class="anchor" id="autotoc_md5"></a>
Nested foreign calls</h1>
<p>If we compose the above it leads to the question of whether you can have multiple nested foreign calls in-progress at the same time. Can you have a C stack like: </p><pre class="fragment">wrenCall()
runInterpreter()
foreignCall()
wrenCall()
runInterpreter()
foreignCall()
...
</pre><p> This does <em>not</em> mean there is a single Wren stack that contains multiple foreign calls. Since each <code><a class="el" href="../../dd/d19/wren_8h.html#a4bbb5e4dc3f5b794c88b4210e30927ba">wrenCall()</a></code> begins a new fiber, any given Wren stack can only ever have a single foreign API call at the top of the stack. I think that's a good invariant.</p>
<p>I believe we should support the above. This means that the core <code><a class="el" href="../../de/db2/wren__vm_8c.html#ade1e713227c5685b4747c982aab961c4">runInterpreter()</a></code> C function is itself re-entrant. So far, I've always assumed it would not be, so it probably breaks some assumptions. I'll have to think through. The main thing that could be problematic is the local variables inside <code><a class="el" href="../../de/db2/wren__vm_8c.html#ade1e713227c5685b4747c982aab961c4">runInterpreter()</a></code>, but I believe <code><a class="el" href="../../de/db2/wren__vm_8c.html#a88dc4ef4f7cfa80d20946dd714bbc860">STORE_FRAME()</a></code> and <code><a class="el" href="../../de/db2/wren__vm_8c.html#aa08153a2694d9c9942ec2881fd72c52e">LOAD_FRAME()</a></code> take care of those. We just need to make sure they get called before any re-entrancy can happen. That probably means calling them before we invoke a foreign method.</p>
<p>I'll have to write some tests and see what blows up for this.</p>
<h1><a class="anchor" id="autotoc_md6"></a>
Calling re-entrant fibers</h1>
<p>Where it gets really confusing is how re-entrant calls interact with fibers. For example, say you: </p><pre class="fragment">wrenCall()       -&gt; creates Fiber #1
runInterpreter() -&gt; runs Fiber #1
                    some Wren code stores current fiber in a variable
foreignCall()
wrenCall()       -&gt; creates Fiber #2
runInterpreter() -&gt; runs Fiber #2
                    some Wren code calls or transfers to Fiber #1
</pre><p> What happens in this scenario? We definitely want to prevent it. We already detect and prevent the case where you call a fiber that's already called in the current <em>Wren</em> stack, so we should be able to do something in the above case too.</p>
<p>Now that I think about it, you can probably already get yourself in a weird state if you grab the root fiber and call it. Yeah, I justed tested. This: </p><pre class="fragment">var root = Fiber.current
Fiber.new {
  root.call()
  System.print(1)
}.call()
System.print(2)
</pre><p> Segfaults the VM. :( It actually dies when the called child fiber <em>returns</em>. The root call successfully continues executing the root fiber (which is super weird). Then that completes and control returns to the spawned fiber. Then <em>that</em> completes and tries to return control to the root fiber, but the root is already done, and it blows up. So the above prints "2" then "1" then dies.</p>
<p>(If either of the <code><a class="el" href="../../d4/de2/wren__compiler_8c.html#abc28d53c9cefc405f7f74cd877d037d1">call()</a></code> calls are change to <code>transfer()</code>, the script runs without any problems because then it never tries to unwind back through the root fiber which already completed.)</p>
<p>To fix this, when <code><a class="el" href="../../de/db2/wren__vm_8c.html#ade1e713227c5685b4747c982aab961c4">runInterpreter()</a></code> begins executing a root fiber (either from <code><a class="el" href="../../dd/d19/wren_8h.html#a4bbb5e4dc3f5b794c88b4210e30927ba">wrenCall()</a></code> or <code><a class="el" href="../../dd/d19/wren_8h.html#a653b065ece2f5fb52dc3ff41e7c8322a">wrenInterpret()</a></code>), we need to mark it in some way so that it can't be called or transferred to.</p>
<h1><a class="anchor" id="autotoc_md7"></a>
Suspending during re-entrancy</h1>
<p>Maybe the weird conceptual case is when you suspend a fiber while there are multiple re-entrant calls to <code><a class="el" href="../../de/db2/wren__vm_8c.html#ade1e713227c5685b4747c982aab961c4">runInterpreter()</a></code> on the C stack. Ideall, they would all magically return, but that's obviously not feasible.</p>
<p>I guess what will/should happen is that just the innermost one suspends. It's up to the host to handle that fact. I need to think about this more, add some tests, and work through it.</p>
<p>I think we'll probably want to add another WrenInterpretResult case for suspension so that the host can tell that's what happened. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
