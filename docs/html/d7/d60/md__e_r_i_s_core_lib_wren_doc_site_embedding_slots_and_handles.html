<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ERIS CORE: slots-and-handles</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">ERIS CORE
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "../../search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('d7/d60/md__e_r_i_s_core_lib_wren_doc_site_embedding_slots_and_handles.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">slots-and-handles </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>^title Slots and Handles</p>
<p>With <code><a class="el" href="../../dd/d19/wren_8h.html#a653b065ece2f5fb52dc3ff41e7c8322a">wrenInterpret()</a></code>, we can execute code, but that code can't do anything particularly interesting. By default, the VM is isolated from the rest of the world, so pretty much all it can do is turn your laptop into a lap warmer.</p>
<p>To make our Wren code <em>useful</em>, the VM needs to communicate with the outside world. Wren uses a single unified set of functions for passing data into and out of the VM. These functions are based on two fundamental concepts: <b>slots</b> and <b>handles</b>.</p>
<h2><a class="anchor" id="autotoc_md191"></a>
The Slot Array</h2>
<p>When you want to send data to Wren, read data from it, or generally monkey around with Wren objects from C, you do so by going through an array of slots. Think of it as a shared message board that both the VM and your C code leave notes on for the other side to process.</p>
<p>The array is zero-based, and each slot can hold a value of any type. It is dynamically sized, but it's your responsibility to ensure there are enough slots <em>before</em> you use them. You do this by calling:</p>
<pre class="snippet" data-lang="c">
<a class="el" href="../../de/db2/wren__vm_8c.html#af192ba7bb689456d81a994e50727da0f">wrenEnsureSlots(WrenVM* vm, int slotCount)</a>;
</pre><p>This grows the slot array if needed to ensure that many slots are available. If it's already big enough, this does nothing. You'll typically call this once before populating the slots with data that you want to send to Wren.</p>
<pre class="snippet" data-lang="c">
wrenEnsureSlots(vm, 4);
// Can now use slots 0 through 3, inclusive.
</pre><p>After you ensure an array of slots, you can only rely on them being there until you pass control back to Wren. That includes calling <code><a class="el" href="../../dd/d19/wren_8h.html#a4bbb5e4dc3f5b794c88b4210e30927ba">wrenCall()</a></code> or <code><a class="el" href="../../dd/d19/wren_8h.html#a653b065ece2f5fb52dc3ff41e7c8322a">wrenInterpret()</a></code>, or returning from a <a href="../../calling-c-from-wren.html">foreign method</a>.</p>
<p>If you read or write from a slot that you haven't ensured is valid, Wren makes no guarantees about what will happen. I've heard rumors of smoke and feathers flying out of a user's computer.</p>
<p>If you want to see how big the slot array is, use:</p>
<pre class="snippet" data-lang="c">
int <a class="el" href="../../de/db2/wren__vm_8c.html#a878f8893f175d615198ae6e04d3b2b58">wrenGetSlotCount(WrenVM* vm)</a>;
</pre><p>It returns the number of slots in the array. Note that this may be higher than the size you've ensured. Wren reuses the memory for this array when possible, so you may get one bigger than you need if it happened to be laying around.</p>
<p>When Wren <a href="../../calling-c-from-wren.html">calls your C code</a> and passes data to you, it ensures there are enough slots for the objects it is sending you.</p>
<h3><a class="anchor" id="autotoc_md195"></a>
Writing slots</h3>
<p>Once you have some slots, you store data in them using a number of functions all named <code>wrenSetSlot&lt;type&gt;()</code> where <code>&lt;type&gt;</code> is the kind of data. We'll start with the simple ones:</p>
<pre class="snippet" data-lang="c">
void <a class="el" href="../../de/db2/wren__vm_8c.html#a33ce26cee6ae751f01499ad0242e0a11">wrenSetSlotBool(WrenVM* vm, int slot, bool value)</a>;
void <a class="el" href="../../de/db2/wren__vm_8c.html#a1d72c7dfa1f743a4c4255d680f5fd3f0">wrenSetSlotDouble(WrenVM* vm, int slot, double value)</a>;
void <a class="el" href="../../de/db2/wren__vm_8c.html#ab5d15eac4a6bab10343a39842ad0d5c1">wrenSetSlotNull(WrenVM* vm, int slot)</a>;
</pre><p>Each of these takes a primitive C value and converts it to the corresponding <a href="../../../values.html">Wren value</a>. (Since Wren's <a href="../../../values.html#numbers">native number type</a> <em>is</em> a double, there's not really much <em>conversion</em> going on, but you get the idea.)</p>
<p>You can also pass string data to Wren:</p>
<pre class="snippet" data-lang="c">
void wrenSetSlotBytes(WrenVM* vm, int slot,
                      const char* bytes, size_t length);

void wrenSetSlotString(WrenVM* vm, int slot,
                       const char* text);
</pre><p>Both of these copy the bytes into a new <a href="../../../values.html#strings">String</a> object managed by Wren's garbage collector, so you can free your copy of it after you call this. The difference between the two is that <code><a class="el" href="../../dd/d19/wren_8h.html#a174a3ba396a558eedecb0b3c4f118748">wrenSetSlotBytes()</a></code> takes an explicit length. Since Wren strings may contain arbitrary byte values, including the null byte, this lets you pass those in. It's also a little faster to use this for regular strings if you happen to know the length. The latter calculates the length of the string using <code>strlen()</code>.</p>
<h3><a class="anchor" id="autotoc_md198"></a>
Reading slots</h3>
<p>You can, of course, also pull data out of slots. Here are the simple ones:</p>
<pre class="snippet" data-lang="c">
bool <a class="el" href="../../de/db2/wren__vm_8c.html#aced2d9889a634ba87a7862327ee97c31">wrenGetSlotBool(WrenVM* vm, int slot)</a>;
double <a class="el" href="../../de/db2/wren__vm_8c.html#a6cbaec67f7e460a02a94685a529a94fc">wrenGetSlotDouble(WrenVM* vm, int slot)</a>;
</pre><p>These take a Wren value of the corresponding type and convert it to its raw C representation. For strings, we have:</p>
<pre class="snippet" data-lang="c">
const char* <a class="el" href="../../de/db2/wren__vm_8c.html#a034ea0abc1018b9ef257a44f223b7934">wrenGetSlotString(WrenVM* vm, int slot)</a>;
const char* wrenGetSlotBytes(WrenVM* vm, int slot,
                             int* length);
</pre><p>These return a pointer to the first byte of the string. If you want to know the length, the latter stores it in the variable pointed to by <code>length</code>. Both of these return a direct pointer to the bytes managed by Wren. You should not hold on to this pointer for long. Wren does not promise that it won't move or free the data.</p>
<p>With these functions, you are going from dynamically typed Wren data to statically typed C. It's up to <em>you</em> to ensure that you read a value as the correct type. If you read a number from a slot that currently holds a string, you're gonna have a bad time.</p>
<p>Fortunately, you usually know what type of data you have in a slot. If not, you can ask:</p>
<pre class="snippet" data-lang="c">
WrenType <a class="el" href="../../de/db2/wren__vm_8c.html#a101a1db2c903f4271983ceab6ebed56f">wrenGetSlotType(WrenVM* vm, int slot)</a>;
</pre><p>This returns an enum defining what type of value is in the slot. It only covers the primitive values that are supported by the C API. Things like ranges and instances of classes come back as <code>WREN_TYPE_UNKNOWN</code>. If you want to move that kind of data between Wren and C, you'll have to pull the object apart into simple primitive values first or use a <a href="../../storing-c-data.html">foreign class</a>.</p>
<h3><a class="anchor" id="autotoc_md200"></a>
Looking up variables</h3>
<p>There are a few other utility functions that move data into and out of slots. Here's the first:</p>
<pre class="snippet" data-lang="c">
void wrenGetVariable(WrenVM* vm, const char* module,
                     const char* name, int slot);
</pre><p>This looks up a top level variable with the given name in the module with the given name and stores its value in the given slot. Note that classes are just objects stored in variables too, so you can use this to look up a class by its name. Handy for calling static methods on it.</p>
<p>Like any method that works with strings, this one is a bit slow. It has to hash the name and look it up in the module's string table. You might want to avoid calling this in the middle of a hot loop where performance is critical. Instead, it's faster to look up the variable once outside the loop and store a reference to the object using a <a href="../../#handles">handle</a>.</p>
<h3><a class="anchor" id="autotoc_md201"></a>
Working with lists</h3>
<p>The slot array is fine for moving a fixed number of objects between Wren and C, but sometimes you need to shuttle a larger or dynamically-sized ball of stuff. <a href="../../../lists.html">List objects</a> work well for that, so the C API lets you work with them directly.</p>
<p>You can create a new empty list from C using:</p>
<pre class="snippet" data-lang="c">
void <a class="el" href="../../de/db2/wren__vm_8c.html#ac98ba4330ae6f0c53dc145b6c7276f1c">wrenSetSlotNewList(WrenVM* vm, int slot)</a>;
</pre><p>It stores the resulting list in the given slot. If you have a list in a slot&mdash;either one you created from C or from Wren&mdash;you can add elements to it using:</p>
<pre class="snippet" data-lang="c">
void wrenInsertInList(WrenVM* vm, int listSlot, int index,
                      int elementSlot);
</pre><p>That's a lot of int parameters:</p>
<ul>
<li><code>listSlot</code> is the slot where the list object is stored. That's the list you'll be modifying. If you created the list from C, it will be the slot you passed to <code><a class="el" href="../../dd/d19/wren_8h.html#a5403cef314eda430adc1706a31968810">wrenSetSlotNewList()</a></code>.</li>
<li><code>index</code> is the index within the list where you want to insert the element. Just like from within Wren, you can use a negative number to count back from the end, so <code>-1</code> appends to the list.</li>
<li><code>elementSlot</code> identifies the slot where the value you want to insert in the list can be found.</li>
</ul>
<p>This API means getting a value from C into a list is a two step operation. First you move the value into a slot, then you take it from the slot and insert it in the list. This is kind of tedious, but it lets us use the same set of functions for moving values into slots of each primitive type. Otherwise, we'd need <code>wrenInsertInListDouble()</code>, <code>wrenInsertInListBool()</code>, etc.</p>
<h2><a class="anchor" id="autotoc_md202"></a>
Handles</h2>
<p>Slots are pretty good for shuttling primitive data between C and Wren, but they have two limitations:</p>
<ol type="1">
<li><b>They are short-lived.</b> As soon as you execute some more Wren code, the slot array is invalidated. You can't use a slot to persistently keep track of some object.</li>
<li><b>They only support primitive types.</b> A slot can hold a value of any type, but the C API we've seen so far doesn't let you <em>do</em> anything with values that aren't simple primitive ones. If you want to grab a reference to, say, an instance of some class, how do you do it?</li>
</ol>
<p>To address those, we have handles. A handle wraps a reference to an object of any kind&mdash;strings, numbers, instances of classes, collections, whatever. You create a handle using this:</p>
<pre class="snippet" data-lang="c">
WrenHandle* <a class="el" href="../../de/db2/wren__vm_8c.html#a2203fe2e09540f4f974d4e76d61abd30">wrenGetSlotHandle(WrenVM* vm, int slot)</a>;
</pre><p>This takes the object stored in the given slot, creates a new <a class="el" href="../../d7/d18/struct_wren_handle.html">WrenHandle</a> to wrap it, and returns a pointer to it back to you. You can send that wrapped object back to Wren by calling:</p>
<pre class="snippet" data-lang="c">
void <a class="el" href="../../de/db2/wren__vm_8c.html#a8066a0390abdc89fff247b04d9dbf833">wrenSetSlotHandle(WrenVM* vm, int slot, WrenHandle* handle)</a>;
</pre><p>Note that this doesn't invalidate your <a class="el" href="../../d7/d18/struct_wren_handle.html">WrenHandle</a>. You can still keep using it.</p>
<h3><a class="anchor" id="autotoc_md203"></a>
Retaining and releasing handles</h3>
<p>A handle is an opaque wrapper around an object of any type, but just as important, it's a <em>persistent</em> one. When Wren gives you a pointer to a <a class="el" href="../../d7/d18/struct_wren_handle.html">WrenHandle</a>, it guarantees that that pointer remains valid. You can keep it around as long as you want. Even if a garbage collection occurs, Wren will ensure the handle and the object it wraps are kept safely in memory.</p>
<p>Internally, Wren keeps a list of all of the WrenHandles that have been created. That way, during garbage collection, it can find them all and make sure their objects aren't freed. But what if you don't want it to be kept around any more? Since C relies on manual memory management, <a class="el" href="../../d7/d18/struct_wren_handle.html">WrenHandle</a> does too. When you are done with one, you must explicitly release it by calling:</p>
<pre class="snippet" data-lang="c">
void <a class="el" href="../../de/db2/wren__vm_8c.html#a3a44c1c23deeb6a70aa34d8379159004">wrenReleaseHandle(WrenVM* vm, WrenHandle* handle)</a>;
</pre><p>This does not immediately delete the wrapped object&mdash;after all, there may be other references to the same object in the program. It just invalidates the <a class="el" href="../../d7/d18/struct_wren_handle.html">WrenHandle</a> wrapper itself. After you call this, you cannot use that pointer again.</p>
<p>You must release every <a class="el" href="../../d7/d18/struct_wren_handle.html">WrenHandle</a> you've created before shutting down the VM. Wren warns you if you don't, since it implies you've probably leaked a resource somewhere.</p>
<p>Now we know how to pass values between Wren and C, but we don't know how to actually <em>do</em> anything with them. Next, we'll learn how to use slots to pass parameters to a Wren method from C...</p>
<p><a href="../../calling-wren-from-c.html" class="right">Calling Wren from C &rarr;</a> <a href="../../index.html">&larr; Introduction</a> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
